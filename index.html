<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Board Pro</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
body, html{margin:0;padding:0;font-family:'Segoe UI',sans-serif;background:#121212;color:#eee;overflow-x:hidden;}
#introScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:#121212;color:#00ff66;display:flex;justify-content:center;align-items:center;flex-direction:column;transition:transform 1s ease-out;z-index:100;}
#introScreen.hide{transform:translateX(-100%);}
#introScreen h1{font-size:3rem;margin:0;}
#introScreen p{font-size:1.2rem;margin-top:1rem;text-align:center;max-width:600px;line-height:1.4;}

header{background:#00ff66;color:#121212;padding:1rem;text-align:center;font-size:1.8rem;font-weight:bold;position:sticky;top:0;z-index:10;cursor:pointer;}
nav{display:flex;justify-content:space-around;background:#222;padding:0.5rem 0;position:sticky;top:56px;z-index:9;}
nav button{padding:0.6rem 1.2rem;border:none;border-radius:6px;font-weight:bold;cursor:pointer;transition:0.3s;color:#eee;background:#333;}
nav button.active{background:#00ff66;color:#121212;}

section{padding:1rem;}
.strategy, .calendar-container, .news-widget{background:#1e1e1e;margin-bottom:1rem;padding:1rem;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.progress-bar{height:20px;background:#333;border-radius:10px;overflow:hidden;margin-top:0.5rem;}
.progress-bar-inner{height:100%;background:#00ff66;width:0%;text-align:center;color:#121212;line-height:20px;font-size:0.85rem;}

.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#333;border-radius:8px;overflow:hidden;}
.calendar div{background:#1e1e1e;min-height:80px;padding:0.4rem;position:relative;font-size:0.9rem;cursor:pointer;transition:0.3s;}
.calendar div:hover{background:#2a2a2a;}
.calendar div span{position:absolute;top:3px;right:5px;font-size:0.75rem;font-weight:bold;}
.entry{margin-top:1.2rem;font-size:0.75rem;display:flex;align-items:center;transition:0.2s;}
.entry i{margin-right:5px;}
.entry .gain{color:#00ff66;font-weight:bold;}
.entry .loss{color:red;font-weight:bold;}

input,textarea,select{width:100%;padding:0.4rem;margin:0.2rem 0;border-radius:5px;border:1px solid #555;background:#222;color:#eee;}
button.addEntry,button.authButton{background:#00ff66;color:#121212;padding:0.5rem;border:none;border-radius:6px;cursor:pointer;width:100%;margin-top:0.5rem;transition:0.2s;}
button.addEntry:hover,button.authButton:hover{background:#00cc55;}

#authContainer{max-width:400px;margin:1rem auto;background:#1e1e1e;padding:1rem;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
#signOutBtn{margin-top:0.5rem;}

#homeBtn{position:fixed;bottom:15px;right:15px;background:#00ff66;color:#121212;padding:0.8rem;border-radius:50%;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
</style>
</head>
<body>

<div id="introScreen">
  <h1>Trade Board Pro</h1>
  <p>Bienvenue sur votre application de suivi de stratégies et journal de trading.<br>
  Planifiez, suivez vos positions et analysez vos performances.<br>
  "Le succès en trading vient de la discipline et de l'organisation."</p>
</div>

<header id="mainHeader">Trade Board Pro</header>

<div id="authContainer">
  <h2>Connexion</h2>
  <input type="email" id="authEmail" placeholder="Adresse e-mail">
  <input type="password" id="authPassword" placeholder="Mot de passe">
  <button class="authButton" id="signInBtn">Se connecter</button>
  <button class="authButton" id="signUpBtn">Créer un compte</button>
  <button class="authButton" id="signOutBtn" style="display:none;">Se déconnecter</button>
  <div id="emailWarning" style="color:red;font-size:0.85rem;display:none;margin-top:0.5rem;">Email non vérifié !</div>
</div>

<nav style="display:none;" id="mainNav">
  <button id="tab-news" class="active">Actualités</button>
  <button id="tab-strategies">Stratégies</button>
  <button id="tab-calendar">Calendrier</button>
</nav>

<section id="section-news" style="display:none;">
  <h2>Actualités financières</h2>
  <div class="news-widget" id="newsContainer">Chargement des news...</div>
</section>

<section id="section-strategies" style="display:none;">
  <h2>Mes stratégies</h2>
  <div class="strategy" draggable="true">
    <strong>Stratégie Exemple</strong>
    <div>
      <label><input type="checkbox" class="condition"> Condition 1</label><br>
      <label><input type="checkbox" class="condition"> Condition 2</label><br>
      <label><input type="checkbox" class="condition"> Condition 3</label><br>
      <div class="progress-bar"><div class="progress-bar-inner">0%</div></div>
      <button class="enterPosition" disabled>Entrer en position</button>
    </div>
  </div>
  <button id="addStrategyBtn" style="margin-top:0.5rem;">Ajouter une stratégie</button>
</section>

<section id="section-calendar" style="display:none;">
  <h2>Calendrier & Journal</h2>
  <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
    <button id="prevMonth">&lt; Mois précédent</button>
    <span id="currentMonth" style="font-weight:bold;"></span>
    <button id="nextMonth">Mois suivant &gt;</button>
  </div>
  <div class="calendar" id="calendar"></div>
  <div id="entryForm" style="margin-top:1rem;">
    <input type="date" id="entryDate">
    <select id="entryAsset">
      <option value="EURUSD">EURUSD</option>
      <option value="GBPUSD">GBPUSD</option>
      <option value="BTCUSD">BTCUSD</option>
      <option value="ETHUSD">ETHUSD</option>
      <option value="XAUUSD">XAU/USD</option>
      <option value="DJ30">DJ30</option>
      <option value="NAS100">NAS100</option>
      <option value="AUTRE">Ajouter un actif...</option>
    </select>
    <select id="entryType"><option value="achat">Achat</option><option value="vente">Vente</option></select>
    <input type="number" id="entryPrice" placeholder="Prix">
    <input type="number" id="entryResult" placeholder="Résultat (gain/perte)">
    <textarea id="entryDescription" placeholder="Description"></textarea>
    <input type="number" id="entryCapital" placeholder="Dépôt/Capital">
    <button class="addEntry">Ajouter l'entrée</button>
  </div>
  <div id="dailyTotal" style="margin-top:1rem;font-weight:bold;"></div>
</section>

<div id="homeBtn"><i class="fas fa-home"></i></div>

<script>
// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyACFzFXKK_1EH6_PVgaQQXD3fc8mBvQRvg",
  authDomain: "perso-journaling.firebaseapp.com",
  projectId: "perso-journaling",
  storageBucket: "perso-journaling.firebasestorage.app",
  messagingSenderId: "660360215177",
  appId: "1:660360215177:web:WEBAPPID_A_REMPLACER"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- Intro dynamique ---
const introScreen = document.getElementById("introScreen");
setTimeout(()=>{
  introScreen.classList.add("hide");
  setTimeout(()=>{introScreen.style.display="none";},1000);
},3000);
introScreen.addEventListener("click",()=>{introScreen.classList.add("hide"); setTimeout(()=>{introScreen.style.display="none";},500);});

// --- Sections et onglets ---
const mainNav = document.getElementById("mainNav");
const sectionNews = document.getElementById("section-news");
const sectionStrategies = document.getElementById("section-strategies");
const sectionCalendar = document.getElementById("section-calendar");

document.getElementById("tab-news").addEventListener("click",()=>{
  sectionNews.style.display="block";
  sectionStrategies.style.display="none";
  sectionCalendar.style.display="none";
  document.getElementById("tab-news").classList.add("active");
  document.getElementById("tab-strategies").classList.remove("active");
  document.getElementById("tab-calendar").classList.remove("active");
});
document.getElementById("tab-strategies").addEventListener("click",()=>{
  sectionNews.style.display="none";
  sectionStrategies.style.display="block";
  sectionCalendar.style.display="none";
  document.getElementById("tab-strategies").classList.add("active");
  document.getElementById("tab-news").classList.remove("active");
  document.getElementById("tab-calendar").classList.remove("active");
});
document.getElementById("tab-calendar").addEventListener("click",()=>{
  sectionNews.style.display="none";
  sectionStrategies.style.display="none";
  sectionCalendar.style.display="block";
  document.getElementById("tab-calendar").classList.add("active");
  document.getElementById("tab-news").classList.remove("active");
  document.getElementById("tab-strategies").classList.remove("active");
});

// --- Authentification ---
const authContainer = document.getElementById("authContainer");
const signOutBtn = document.getElementById("signOutBtn");
const emailWarning = document.getElementById("emailWarning");

auth.onAuthStateChanged(user=>{
  if(user){
    if(!user.emailVerified){emailWarning.style.display="block"; auth.signOut(); return;}
    emailWarning.style.display="none";
    authContainer.style.display="none";
    mainNav.style.display="flex";
    sectionNews.style.display="block";
    sectionStrategies.style.display="none";
    sectionCalendar.style.display="none";
    signOutBtn.style.display="block";
    loadUserData(user.uid);
  } else {
    authContainer.style.display="block";
    mainNav.style.display="none";
    signOutBtn.style.display="none";
    sectionNews.style.display="none";
    sectionStrategies.style.display="none";
    sectionCalendar.style.display="none";
  }
});

document.getElementById("signInBtn").addEventListener("click",()=>{
  const email=document.getElementById("authEmail").value;
  const password=document.getElementById("authPassword").value;
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert(err.message));
});

document.getElementById("signUpBtn").addEventListener("click",async()=>{
  const email=prompt("Email:");
  const password=prompt("Mot de passe:");
  try{
    const userCredential=await auth.createUserWithEmailAndPassword(email,password);
    const user=userCredential.user;
    await user.sendEmailVerification();
    alert("Compte créé ! Vérifiez votre email.");
  }catch(err){alert(err.message);}
});

signOutBtn.addEventListener("click",()=>auth.signOut());

document.getElementById("homeBtn").addEventListener("click",()=>{
  sectionNews.style.display="block";
  sectionStrategies.style.display="none";
  sectionCalendar.style.display="none";
  document.getElementById("tab-news").classList.add("active");
  document.getElementById("tab-strategies").classList.remove("active");
  document.getElementById("tab-calendar").classList.remove("active");
});

// --- Finnhub news ---
const newsContainer = document.getElementById("newsContainer");
const FINNHUB_API_KEY = "d3ber21r01qqg7bua73gd3ber21r01qqg7bua740";

async function loadNews(){
  try{
    const res = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_API_KEY}`);
    const data = await res.json();
    newsContainer.innerHTML="";
    data.slice(0,10).forEach(n=>{
      const div=document.createElement("div");
      div.style.borderBottom="1px solid #555"; div.style.padding="0.5rem 0";
      div.innerHTML=`<strong>${n.headline}</strong><br><small>${new Date(n.datetime*1000).toLocaleString()}</small>`;
      newsContainer.appendChild(div);
    });
  }catch(e){
    newsContainer.textContent="Erreur de chargement des news.";
    console.error(e);
  }
}
loadNews();

// --- Stratégies ---
document.querySelectorAll(".strategy").forEach(strat=>{
  const conditions=strat.querySelectorAll(".condition");
  const progressBar=strat.querySelector(".progress-bar-inner");
  const enterBtn=strat.querySelector(".enterPosition");
  conditions.forEach(cond=>cond.addEventListener("change",()=>{
    const total=conditions.length;
    const checked=strat.querySelectorAll(".condition:checked").length;
    const percent=Math.round((checked/total)*100);
    progressBar.style.width=percent+"%";
    progressBar.textContent=percent+"%";
    enterBtn.disabled=checked!==total;
  }));
});

// --- Ajouter stratégie ---
document.getElementById("addStrategyBtn").addEventListener("click",()=>{
  const name=prompt("Nom de la stratégie:");
  if(!name) return;
  const div=document.createElement("div");
  div.className="strategy"; div.draggable=true;
  div.innerHTML=`<strong>${name}</strong><div>
      <label><input type="checkbox" class="condition"> Condition 1</label><br>
      <button class="enterPosition" disabled>Entrer en position</button>
      <div class="progress-bar"><div class="progress-bar-inner">0%</div></div>
    </div>`;
  sectionStrategies.appendChild(div);
});

// --- Calendrier ---
const calendarEl = document.getElementById("calendar");
const prevMonthBtn = document.getElementById("prevMonth");
const nextMonthBtn = document.getElementById("nextMonth");
const currentMonthLabel = document.getElementById("currentMonth");
const entryDateInput = document.getElementById("entryDate");
const entryAssetInput = document.getElementById("entryAsset");
const entryTypeInput = document.getElementById("entryType");
const entryPriceInput = document.getElementById("entryPrice");
const entryResultInput = document.getElementById("entryResult");
const entryDescriptionInput = document.getElementById("entryDescription");
const entryCapitalInput = document.getElementById("entryCapital");
let entries = {};
let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();

function renderCalendar(month=currentMonth,year=currentYear){
  calendarEl.innerHTML="";
  const firstDay = new Date(year,month,1).getDay();
  const lastDate = new Date(year,month+1,0).getDate();
  const daysInWeek=["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"];
  daysInWeek.forEach(d=>{const div=document.createElement("div"); div.style.fontWeight="bold"; div.style.background="#333"; div.textContent=d; calendarEl.appendChild(div);});
  for(let i=0;i<firstDay;i++) calendarEl.appendChild(document.createElement("div"));
  for(let d=1;d<=lastDate;d++){
    const div=document.createElement("div");
    const dateStr=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    div.textContent=d;
    if(entries[dateStr]){
      let total=0;
      entries[dateStr].forEach(en=>{
        const eDiv=document.createElement("div");
        eDiv.className="entry";
        const icon = en.type==="achat"?"fa-arrow-up":"fa-arrow-down";
        eDiv.innerHTML=`<i class="fas ${icon}"></i>${en.asset} ${en.result>0?'<span class="gain">+'+en.result+'</span>':'<span class="loss">'+en.result+'</span>'}`;
        total+=en.result;
        div.appendChild(eDiv);
      });
      div.style.background = total>=0?"#003300":"#330000";
      document.getElementById("dailyTotal").textContent="Gains total du jour: "+total;
    }
    div.addEventListener("dblclick",()=>{
      entryDateInput.value=dateStr;
      if(entries[dateStr]){
        const firstEntry = entries[dateStr][0];
        entryAssetInput.value = firstEntry.asset;
        entryTypeInput.value = firstEntry.type;
        entryPriceInput.value = firstEntry.price;
        entryResultInput.value
        entryResultInput.value = firstEntry.result;
        entryDescriptionInput.value = firstEntry.desc;
        entryCapitalInput.value = firstEntry.capital || "";
      } else {
        entryAssetInput.value = "";
        entryTypeInput.value = "achat";
        entryPriceInput.value = "";
        entryResultInput.value = "";
        entryDescriptionInput.value = "";
        entryCapitalInput.value = "";
      }
      sectionCalendar.scrollIntoView({behavior:"smooth"});
    });
    calendarEl.appendChild(div);
  }
  currentMonthLabel.textContent=new Date(year,month).toLocaleString('fr-FR',{month:'long',year:'numeric'});
}

prevMonthBtn.addEventListener("click",()=>{
  currentMonth--;
  if(currentMonth<0){currentMonth=11; currentYear--;}
  renderCalendar();
});
nextMonthBtn.addEventListener("click",()=>{
  currentMonth++;
  if(currentMonth>11){currentMonth=0; currentYear++;}
  renderCalendar();
});

document.querySelector(".addEntry").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user){alert("Connecte-toi !"); return;}
  const date = entryDateInput.value;
  if(!date){alert("Choisis une date !"); return;}
  const asset = entryAssetInput.value;
  const type = entryTypeInput.value;
  const price = parseFloat(entryPriceInput.value);
  const result = parseFloat(entryResultInput.value);
  const desc = entryDescriptionInput.value;
  const capital = parseFloat(entryCapitalInput.value) || 0;
  
  if(!entries[date]) entries[date] = [];
  entries[date].push({asset,type,price,result,desc,capital});
  
  renderCalendar();
  
  await db.collection("users").doc(user.uid).collection("journal").add({
    date, asset, type, price, result, desc, capital, userId: user.uid
  });
  
  entryAssetInput.value = "";
  entryPriceInput.value = "";
  entryResultInput.value = "";
  entryDescriptionInput.value = "";
  entryCapitalInput.value = "";
});

async function loadUserData(uid){
  entries = {};
  const snapshot = await db.collection("users").doc(uid).collection("journal").get();
  snapshot.forEach(doc=>{
    const data = doc.data();
    if(!entries[data.date]) entries[data.date] = [];
    entries[data.date].push({
      asset: data.asset,
      type: data.type,
      price: data.price,
      result: data.result,
      desc: data.desc,
      capital: data.capital || 0
    });
  });
  renderCalendar();
}

renderCalendar();
